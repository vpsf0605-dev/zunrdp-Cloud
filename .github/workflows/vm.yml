name: ZUNRDP Cloud
on:
  workflow_dispatch:
    inputs:
      access_key:
        description: 'Nhap Key cua ban'
        required: true

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: ðŸ” XÃ¡c thá»±c & TÃ¬m chá»§ sá»Ÿ há»¯u
        shell: powershell
        run: |
          $inputKey = "${{ github.event.inputs.access_key }}"
          if ($inputKey -eq "ADMIN-MASTER") {
              $owner = "ZunRdp"
          } else {
              $usersUrl = "https://zunrdp-default-rtdb.asia-southeast1.firebasedatabase.app/users.json"
              $allUsers = Invoke-RestMethod -Uri $usersUrl -Method Get
              $owner = $null
              foreach ($username in $allUsers.PSObject.Properties.Name) {
                  if ($allUsers.$username.key -eq $inputKey) {
                      $owner = $username
                      break
                  }
              }
              if ($null -eq $owner) { Write-Error "Sai Key!"; exit 1 }
          }
          echo "VM_OWNER=$owner" >> $env:GITHUB_ENV

      - name: ðŸ›  CÃ i Ä‘áº·t Tailscale
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "ts.exe"
          Start-Process -FilePath ".\ts.exe" -ArgumentList "/quiet" -Wait
          $ts = "C:\Program Files\Tailscale\tailscale.exe"
          $key = "${{ secrets.TAILSCALE_AUTHKEY }}"
          & $ts up --authkey=$key --accept-routes --accept-dns=false --unattended

      - name: ðŸ’» Cáº¥u hÃ¬nh Administrator & RDP
        shell: powershell
        run: |
          $Pass = "ZunRDP@123456"
          # KÃ­ch hoáº¡t Administrator máº·c Ä‘á»‹nh vÃ  Ä‘áº·t máº­t kháº©u
          net user Administrator $Pass /active:yes
          
          # Cho phÃ©p RDP vÃ  táº¯t NLA Ä‘á»ƒ dá»… káº¿t ná»‘i
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0

      - name: ðŸš€ Khá»Ÿi cháº¡y Script giÃ¡m sÃ¡t
        run: |
          $ID = "ZUN-" + (Get-Random -Minimum 1000 -Maximum 9999)
          powershell -ExecutionPolicy Bypass -File ./run_vm.ps1 -Owner "$env:VM_OWNER" -MachineID $ID
          
