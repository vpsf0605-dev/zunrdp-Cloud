name: üåê ZUNRDP Cloud

on:
  workflow_dispatch:
    inputs:
      machine_name:
        description: 'Chon he dieu hanh (Windows hoac Ubuntu)'
        required: true
        type: choice
        default: 'Windows'
        options:
          - Windows
          - Ubuntu
      owner_name:
        description: 'Nhap ten cua ban (De quan ly tren Web)'
        required: true
        default: 'User1'

jobs:
  setup-vm:
    runs-on: ${{ github.event.inputs.machine_name == 'Windows' && 'windows-latest' || 'ubuntu-latest' }}
    timeout-minutes: 360
    
    steps:
      - name: 1. LAY MA NGUON
        [span_2](start_span)uses: actions/checkout@v4[span_2](end_span)

      # ================= CHAY TREN WINDOWS =================
      - name: 2. CAI TAILSCALE (WINDOWS)
        if: github.event.inputs.machine_name == 'Windows'
        shell: powershell
        env:
          TS_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          $msi = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i", $msi, "/quiet", "/norestart" -Wait
          [span_3](start_span)Start-Sleep -Seconds 10[span_3](end_span)

      - name: 3. THIET LAP USER & RDP (WINDOWS)
        if: github.event.inputs.machine_name == 'Windows'
        shell: powershell
        run: |
          net user ADMINZUN ZunRDP@123456 /add
          net localgroup administrators ADMINZUN /add
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          [span_4](start_span)Enable-NetFirewallRule -DisplayGroup "Remote Desktop"[span_4](end_span)

      - name: 4. KICH HOAT AGENT (WINDOWS)
        if: github.event.inputs.machine_name == 'Windows'
        shell: powershell
        env:
          TS_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
          VM_OWNER: ${{ github.event.inputs.owner_name }}
        run: |
          [span_5](start_span)[span_6](start_span).\run_vm.ps1[span_5](end_span)[span_6](end_span)

      # ================= CHAY TREN UBUNTU =================
      - name: 5. CAI DAT MOI TRUONG (UBUNTU)
        if: github.event.inputs.machine_name == 'Ubuntu'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y xrdp
          [span_7](start_span)curl -fsSL https://tailscale.com/install.sh | sh[span_7](end_span)

      - name: 6. KICH HOAT AGENT (UBUNTU)
        if: github.event.inputs.machine_name == 'Ubuntu'
        shell: bash
        env:
          TS_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
          VM_OWNER: ${{ github.event.inputs.owner_name }}
        run: |
          chmod +x run_ubuntu.sh
          [span_8](start_span)./run_ubuntu.sh[span_8](end_span)

