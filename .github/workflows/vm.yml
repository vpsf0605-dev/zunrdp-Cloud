name: ZUNRDP Cloud
on:
  workflow_dispatch:
    inputs:
      access_key:
        description: 'Nhap Key cua ban'
        required: true

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: üîê X√°c th·ª±c & T√¨m ch·ªß s·ªü h·ªØu
        shell: powershell
        run: |
          $inputKey = "${{ github.event.inputs.access_key }}"
          if ($inputKey -eq "ADMIN-MASTER") {
              $owner = "ZunRdp"
          } else {
              $usersUrl = "https://zunrdp-default-rtdb.asia-southeast1.firebasedatabase.app/users.json"
              $allUsers = Invoke-RestMethod -Uri $usersUrl -Method Get
              $owner = $null
              foreach ($username in $allUsers.PSObject.Properties.Name) {
                  if ($allUsers.$username.key -eq $inputKey) {
                      $owner = $username
                      break
                  }
              }
              if ($null -eq $owner) { Write-Error "Sai Key!"; exit 1 }
          }
          echo "VM_OWNER=$owner" >> $env:GITHUB_ENV

      - name: üõ† C√†i ƒë·∫∑t Tailscale
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "ts.exe"
          Start-Process -FilePath ".\ts.exe" -ArgumentList "/quiet" -Wait
          $ts = "C:\Program Files\Tailscale\tailscale.exe"
          $key = "${{ secrets.TAILSCALE_AUTHKEY }}"
          & $ts up --authkey=$key --accept-routes --accept-dns=false --unattended

      - name: üíª C·∫•u h√¨nh Administrator (Fix l·ªói 2221)
        shell: powershell
        run: |
          $User = "Administrator"
          $Pass = "ZunRDP@123456"
          
          # Ki·ªÉm tra s·ª± t·ªìn t·∫°i c·ªßa user
          $userExists = net user | Select-String -Pattern "\b$User\b"
          
          if ($null -eq $userExists) {
              Write-Host "Kh√¥ng t√¨m th·∫•y Administrator, ƒëang t·∫°o m·ªõi..."
              net user $User $Pass /add /y
          } else {
              Write-Host "ƒê√£ t√¨m th·∫•y Administrator, ƒëang c·∫≠p nh·∫≠t m·∫≠t kh·∫©u..."
              net user $User $Pass
          }

          # K√≠ch ho·∫°t t√†i kho·∫£n v√† c·∫•p quy·ªÅn Admin
          net user $User /active:yes
          net localgroup Administrators $User /add

          # M·ªü RDP & T·∫Øt b·∫£o m·∫≠t NLA ƒë·ªÉ tr√°nh l·ªói k·∫øt n·ªëi
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0

      - name: üöÄ Kh·ªüi ch·∫°y Script gi√°m s√°t
        run: |
          $ID = "ZUN-" + (Get-Random -Minimum 1000 -Maximum 9999)
          powershell -ExecutionPolicy Bypass -File ./run_vm.ps1 -Owner "$env:VM_OWNER" -MachineID $ID
          
