name: ZUNRDP Cloud
on:
  workflow_dispatch:
    inputs:
      access_key:
        description: 'Nhap Key cua ban vao day'
        required: true

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: üîê X√°c th·ª±c & T√¨m ch·ªß s·ªü h·ªØu
        shell: powershell
        run: |
          $inputKey = "${{ github.event.inputs.access_key }}"
          if ($inputKey -eq "ADMIN-MASTER") {
              $owner = "ZunRdp"
          } else {
              $usersUrl = "https://zunrdp-default-rtdb.asia-southeast1.firebasedatabase.app/users.json"
              $allUsers = Invoke-RestMethod -Uri $usersUrl -Method Get
              $owner = $null
              foreach ($username in $allUsers.PSObject.Properties.Name) {
                  if ($allUsers.$username.key -eq $inputKey) {
                      $owner = $username
                      break
                  }
              }
              if ($null -eq $owner) { Write-Error "Key sai!"; exit 1 }
          }
          echo "VM_OWNER=$owner" >> $env:GITHUB_ENV

      - name: üõ† C√†i ƒë·∫∑t Tailscale & K·∫øt n·ªëi
        shell: powershell
        run: |
          # 1. T·∫£i v√† c√†i ƒë·∫∑t
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "tailscale-setup.exe"
          Start-Process -FilePath ".\tailscale-setup.exe" -ArgumentList "/quiet" -Wait
          
          # 2. ƒê·ª£i d·ªãch v·ª• Tailscale kh·ªüi ƒë·ªông ho√†n to√†n
          $tsPath = "C:\Program Files\Tailscale\tailscale.exe"
          for ($i=0; $i -lt 10; $i++) {
              if (Test-Path $tsPath) { break }
              Start-Sleep -Seconds 2
          }

          # 3. Ki·ªÉm tra Secret tr∆∞·ªõc khi ch·∫°y
          $authKey = "${{ secrets.TAILSCALE_AUTHKEY }}"
          if ([string]::IsNullOrEmpty($authKey)) {
              Write-Error "L·ªñI: B·∫°n ch∆∞a th√™m TAILSCALE_AUTHKEY v√†o GitHub Secrets!"
              exit 1
          }

          # 4. K·∫øt n·ªëi v·ªõi l·ªánh chu·∫©n
          & $tsPath up --authkey=$authKey --accept-routes --accept-dns=false

      - name: üíª Setup RDP & User
        run: |
          $Password = ConvertTo-SecureString "ZunRDP@123456" -AsPlainText -Force
          Set-LocalUser -Name "runneradmin" -Password $Password
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: üöÄ Run App
        run: |
          $ID = "ZUN-" + (Get-Random -Minimum 1000 -Maximum 9999)
          ./run_vm.ps1 -Owner "$env:VM_OWNER" -MachineID $ID

