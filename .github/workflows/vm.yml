name: ZUNRDP Cloud
on:
  workflow_dispatch:
    inputs:
      access_key:
        description: 'Nhap Key cua ban vao day'
        required: true

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: ðŸ” XÃ¡c thá»±c & TÃ¬m chá»§ sá»Ÿ há»¯u
        shell: powershell
        run: |
          $inputKey = "${{ github.event.inputs.access_key }}"
          
          # 1. Kiá»ƒm tra náº¿u lÃ  Key Admin tá»‘i cao
          if ($inputKey -eq "ADMIN-MASTER") {
              $owner = "ZunRdp"
              Write-Host "âœ… Chao Admin ZunRdp!"
          } else {
              # 2. Náº¿u khÃ´ng pháº£i Admin, quÃ©t toÃ n bá»™ danh sÃ¡ch User trÃªn Firebase Ä‘á»ƒ tÃ¬m xem Key nÃ y cá»§a ai
              $usersUrl = "https://zunrdp-default-rtdb.asia-southeast1.firebasedatabase.app/users.json"
              $allUsers = Invoke-RestMethod -Uri $usersUrl -Method Get
              
              $owner = $null
              foreach ($username in $allUsers.PSObject.Properties.Name) {
                  if ($allUsers.$username.key -eq $inputKey) {
                      $owner = $username
                      break
                  }
              }
              
              if ($null -eq $owner) {
                  Write-Error "âŒ Key nay khong ton tai hoac da bi thu hoi!"
                  exit 1
              }
              Write-Host "âœ… Xac thuc thanh cong! Chu so huu: $owner"
          }
          
          # LÆ°u tÃªn chá»§ sá»Ÿ há»¯u vÃ o biáº¿n mÃ´i trÆ°á»ng Ä‘á»ƒ dÃ¹ng cho bÆ°á»›c sau
          echo "VM_OWNER=$owner" >> $env:GITHUB_ENV

      - name: Setup Tailscale
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "tailscale.exe"
          Start-Process -FilePath ".\tailscale.exe" -ArgumentList "/quiet" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Setup RDP
        run: |
          $Password = ConvertTo-SecureString "ZunRDP@123456" -AsPlainText -Force
          Set-LocalUser -Name "runneradmin" -Password $Password
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Run App
        run: |
          $ID = "ZUN-" + (Get-Random -Minimum 1000 -Maximum 9999)
          # Sá»­ dá»¥ng biáº¿n $env:VM_OWNER Ä‘Ã£ tÃ¬m tháº¥y á»Ÿ bÆ°á»›c trÃªn
          ./run_vm.ps1 -Owner "$env:VM_OWNER" -MachineID $ID
          
